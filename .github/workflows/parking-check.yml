name: パーキング空き状況チェック

on:
  schedule:
    # 3分ごとに実行（テスト用）
    # 本番環境では1時間ごと（cron: '0 * * * *'）に戻してください
    - cron: '*/3 * * * *'  # 3分ごと（UTC）
  
  # 手動実行も可能
  workflow_dispatch:

jobs:
  check-parking:
    runs-on: ubuntu-latest
    
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4
      
      - name: Javaをセットアップ
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Gradleでビルド
        working-directory: ./checkParking/kotlin
        run: |
          chmod +x gradlew || true
          ./gradlew build --no-daemon
      
      - name: 設定ファイルを準備
        working-directory: ./checkParking/kotlin
        run: |
          # GitHub Secretsから設定を読み込んでconfig.jsonを作成
          cat > config.json << EOF
          {
            "url": "${{ secrets.PARKING_URL || 'https://monthly.mkp.jp/parking/001150-0F/' }}",
            "email": {
              "smtpServer": "${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}",
              "smtpPort": ${{ secrets.SMTP_PORT || 587 }},
              "fromEmail": "${{ secrets.FROM_EMAIL }}",
              "fromPassword": "${{ secrets.FROM_PASSWORD }}",
              "toEmail": "${{ secrets.TO_EMAIL }}"
            },
            "checkIntervalMinutes": 10
          }
          EOF
      
      - name: 前回の状態をクリア（テスト用：毎回メール送信）
        working-directory: ./checkParking/kotlin
        run: |
          # テスト用：state.jsonを削除して毎回メールを送信
          rm -f state.json || true
          echo "テストモード：前回の状態をクリアしました（毎回メール送信）"
      
      - name: パーキングをチェック
        working-directory: ./checkParking/kotlin
        run: |
          ./gradlew run --no-daemon
        env:
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          FROM_PASSWORD: ${{ secrets.FROM_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          TEST_MODE: "true"  # テストモード：満車でもメール送信
      
      - name: 状態を保存
        working-directory: ./checkParking/kotlin
        if: always()
        run: |
          # 状態ファイルをGitHub Actionsのアーティファクトとして保存
          if [ -f state.json ]; then
            echo "状態を保存しました"
          fi
      
      - name: エラー時に通知
        if: failure()
        run: |
          echo "⚠️ パーキングチェックでエラーが発生しました"

